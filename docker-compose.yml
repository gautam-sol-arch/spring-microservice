services:
  # Eureka Discovery Server
  discovery-server:
    build:
      context: ./backend/discovery-server
      dockerfile: Dockerfile
    ports:
      - "8761:8761"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8761/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Config Server
  config-server:
    build:
      context: ./backend/config-server
      dockerfile: Dockerfile
    ports:
      - "8888:8888"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
    depends_on:
      discovery-server:
        condition: service_healthy
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8888/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # RabbitMQ for Spring Cloud Bus
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=admin
      - RABBITMQ_DEFAULT_PASS=admin
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Account Service
  account-service:
    build:
      context: ./backend/account-service
      dockerfile: Dockerfile
    ports:
      - "8083:8083"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
      - SPRING_CONFIG_IMPORT=configserver:http://config-server:8888
      - SPRING_RABBITMQ_HOST=rabbitmq
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_USERNAME=admin
      - SPRING_RABBITMQ_PASSWORD=admin
      - SPRING_DATASOURCE_URL=jdbc:h2:mem:accountdb
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=org.h2.Driver
      - SPRING_DATASOURCE_USERNAME=sa
      - SPRING_DATASOURCE_PASSWORD=password
      - SPRING_JPA_DATABASE_PLATFORM=org.hibernate.dialect.H2Dialect
      - SPRING_JPA_HIBERNATE_DDL_AUTO=create-drop
      - SPRING_H2_CONSOLE_ENABLED=true
      - JWT_SECRET=${JWT_SECRET:-U2VjcmV0S2V5Rm9ySldUU2lnbmluZ0tleUZvckpXVFNpZ25pbmdLZXlGb3JKV1RTaWduaW5nS2V5}
      - GATEWAY_SECRET=${GATEWAY_SECRET:-InternalGatewaySecret123}
    depends_on:
      discovery-server:
        condition: service_healthy
      config-server:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8083/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # User Service
#  user-service:
#    build:
#      context: ./backend/user-service
#      dockerfile: Dockerfile
#    ports:
#      - "8082:8082"
#    environment:
#      - SPRING_PROFILES_ACTIVE=docker
#      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
#      - SPRING_CONFIG_IMPORT=configserver:http://config-server:8888
#      - SPRING_RABBITMQ_HOST=rabbitmq
#      - SPRING_RABBITMQ_PORT=5672
#      - SPRING_RABBITMQ_USERNAME=admin
#      - SPRING_RABBITMQ_PASSWORD=admin
#      - JWT_SECRET=${JWT_SECRET:-U2VjcmV0S2V5Rm9ySldUU2lnbmluZ0tleUZvckpXVFNpZ25pbmdLZXlGb3JKV1RTaWduaW5nS2V5}
#      - GATEWAY_SECRET=${GATEWAY_SECRET:-InternalGatewaySecret123}
#    depends_on:
#      discovery-server:
#        condition: service_healthy
#      config-server:
#        condition: service_healthy
#      rabbitmq:
#        condition: service_healthy
#    networks:
#      - microservices-network
#    healthcheck:
#      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8082/actuator/health"]
#      interval: 30s
#      timeout: 10s
#      retries: 3

  # Card Service
  card-service:
    build:
      context: ./backend/card-service
      dockerfile: Dockerfile
    ports:
      - "8084:8084"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
      - SPRING_CONFIG_IMPORT=configserver:http://config-server:8888
      - SPRING_RABBITMQ_HOST=rabbitmq
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_USERNAME=admin
      - SPRING_RABBITMQ_PASSWORD=admin
      - JWT_SECRET=${JWT_SECRET:-U2VjcmV0S2V5Rm9ySldUU2lnbmluZ0tleUZvckpXVFNp25pbmdLZXlGb0pSVRTaWduaW5nZ2V5}
      - GATEWAY_SECRET=${GATEWAY_SECRET:-InternalGatewaySecret123}
    depends_on:
      discovery-server:
        condition: service_healthy
      config-server:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8084/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Loan Service
  loan-service:
    build:
      context: ./backend
      dockerfile: loan-service/Dockerfile
    ports:
      - "8085:8085"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
      - SPRING_CONFIG_IMPORT=configserver:http://config-server:8888
      - SPRING_RABBITMQ_HOST=rabbitmq
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_USERNAME=admin
      - SPRING_RABBITMQ_PASSWORD=admin
      - JWT_SECRET=${JWT_SECRET:-U2VjcmV0S2V5Rm9ySldUU2lnbmluZ0tleUZvckpXVFNpZ25pbmdLZXlGb3JKV1RTaWduaW5nS2V5}
      - GATEWAY_SECRET=${GATEWAY_SECRET:-InternalGatewaySecret123}
      - DB_USERNAME=${DB_USERNAME:-sa}
      - DB_PASSWORD=${DB_PASSWORD:-password}
    depends_on:
      discovery-server:
        condition: service_healthy
      config-server:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8085/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # API Gateway
  api-gateway:
    build:
      context: ./backend/api-gateway
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-server:8761/eureka
      - JWT_SECRET=${JWT_SECRET:-U2VjcmV0S2V5Rm9ySldUU2lnbmluZ0tleUZvckpXVFNpZ25pbmdLZXlGb3JKV1RTaWduaW5nS2V5}
      - GATEWAY_SECRET=${GATEWAY_SECRET:-InternalGatewaySecret123}
    depends_on:
      discovery-server:
        condition: service_healthy
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  microservices-network:
    driver: bridge
